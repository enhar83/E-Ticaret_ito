@{
    ViewData["Title"] = "Index";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<h6 class="mb-0 text-uppercase">Kategoriler</h6>
<hr />
<div>
    <div class="card">
        <div class="card-header text-white bg-primary bg-gradient">
            <a href="#" id="btnEkle" class="btn btn-info ms-2">Yeni Kategori Ekle</a>
        </div>
        <div class="card-body">
            <table id="categoryTable" class="table table-bordered table-striped" style="width:100%">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Kategori Adı</th>
                        <th>Oluşturulma Tarihi</th>
                        <th>Durum</th>
                        <th>İşlemler</th>
                    </tr>
                </thead>
            </table>
        </div>
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="modalCategory" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false" role="dialog"
     aria-labelledby="modalCategoryTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-md" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalCategoryTitle">Yeni Kategori Ekle</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="categoryId" />
                <div class="mb-3">
                    <label class="form-label">Kategori Adı</label>
                    <input type="text" id="categoryTitle" class="form-control" placeholder="Kategori adı girin..." />
                </div>
                <div class="form-check mb-3">
                    <input type="checkbox" id="categoryIsActive" class="form-check-input" checked />
                    <label class="form-check-label" for="categoryIsActive">Aktif</label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
                <button type="button" id="btnSave" class="btn btn-primary">Kaydet</button>
            </div>
        </div>
    </div>
</div>

<!-- Gerekli scriptler -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" />

<script>
    $(document).ready(function () { // sayfadaki Html yüklendiğinde çalışacak fonksiyon
        var table = $('#categoryTable').DataTable({ // categoryTable adındaki tableı bul ve DataTable kütüphanesini uygula.
            ajax: {
                url: "/Admin/Category/GetAll", //çekilecek verinin controllerı ve action adı
                dataSrc: "data" //json ile verilerin geldiği alan 
            },
            columns: [ //tablonun sütunlarının tanımlandığı kısım
                {
                    data: null, //ilk sütun veri kaynağına bağlı değil, sadece satır numarasını gösterecek
                    render: function (data, type, row, meta) { //render ile satır numarası
                        return meta.row + 1; //default olarak 0dan başlaığı için +1 ile 1den başlatıyoruz
                    }
                },
                { data: "title" }, //ikinci sütun kategorinin adı
                {
					data: "createdDate", //üçüncü sütun oluşturulma tarihi
                    render: function (data) {
                        if (!data) return "-"; //eğer tarih yoksa - göster
                        let date = new Date(data); //tarihi JS Date nesnesine çevir
                        return date.toLocaleDateString('tr-TR', { //tarihi tr formatında göster
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                    }
                },
                {
                    data: "isActive", //kategorinin aktiflik bilgisi
                    render: function (data) {
                        return data ? "Aktif" : "Pasif"; //true ise Aktif, false ise Pasif yazacak
                    }
                },
                {
                    data: 'id',
                    render: function (id, type, row) {
                        //her satır sonunda iki buton olacak, sil ve düzenle 
                        return `
                            <button class="btn btn-sm btn-info btn-edit" data-id="${id}">Düzenle</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteCategory('${id}')">Sil</button>`;
                    }
                }
            ]
        });

        // Yeni ekleme butonu
        $("#btnEkle").click(function () {
            $("#categoryId").val(''); //id alanını ve altındaki title alanını .val('') ile temizler.
            $("#categoryTitle").val('');
            $("#categoryIsActive").prop('checked', true); //checkbox'ı otomatik olarak true getirir
            $("#modalCategoryTitle").text('Yeni Kategori Ekle'); //modal başlığını ayarlar.
            $("#modalCategory").modal("show"); //modalı açar
        });

        // Kaydetme işlemi (Ekleme veya Güncelleme)
        $("#btnSave").click(function () {
            var id = $('#categoryId').val();
            var title = $("#categoryTitle").val().trim();
            var isActive = $("#categoryIsActive").is(':checked');

            if (!title) {
                Swal.fire('Uyarı!', 'Kategori adı boş olamaz.', 'warning');
                return;
            }

            var data = {
                Title: title,
                IsActive: isActive
            };
            if (id) data.Id = id;

            var url = id ? "/Admin/Category/Edit" : "/Admin/Category/Add";

            $.ajax({
                url: url,
                type: "POST",
                data: data,
                success: function () {
                    $("#modalCategory").modal("hide");
                    Swal.fire('Başarılı!', id ? 'Kategori güncellendi.' : 'Kategori eklendi.', 'success');
                    table.ajax.reload();
                },
                error: function (xhr) {
                    Swal.fire('Hata!', xhr.responseText || 'İşlem başarısız.', 'error');
                }
            });
        });

        // Düzenle
        $(document).on('click', '.btn-edit', function () {
            var id = $(this).data('id');
            $.getJSON('/Admin/Category/GetById', { id }, function (res) {
                if (!res.success) return Swal.fire('Hata!', res.message, 'error');

                var c = res.data;
                $('#modalCategoryTitle').text('Kategori Düzenle');
                $('#categoryId').val(c.id);
                $('#categoryTitle').val(c.title);
                $('#categoryIsActive').prop('checked', c.isActive);
                $('#modalCategory').modal('show');
            });
        });
    });

    // Silme
    function deleteCategory(id) {
        Swal.fire({
            title: 'Emin misiniz?',
            text: "Bu kategoriyi silmek istediğinize emin misiniz?",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Evet, sil!',
            cancelButtonText: 'Vazgeç'
        }).then((result) => {
            if (result.isConfirmed) {
                $.ajax({
                    url: "/Admin/Category/Delete",
                    type: "POST",
                    data: { id: id },
                    success: function () {
                        $('#categoryTable').DataTable().ajax.reload();
                        Swal.fire('Başarılı!', 'Kategori silindi.', 'success');
                    },
                    error: function (xhr) {
                        Swal.fire('Hata!', xhr.responseText || 'Silme işlemi başarısız.', 'error');
                    }
                });
            }
        });
    }
</script>
